<div class="space-y-6">
  <div class="flex items-center gap-3">
    <h2 class="text-xl font-semibold">⭐ Financial Metrics (V2)</h2>
    <button class="text-sm px-3 py-1.5 rounded border bg-white hover:bg-gray-50" (click)="refresh()">Reload</button>
    <span *ngIf="loading()" class="text-sm text-gray-500">Loading...</span>
    <span *ngIf="error()" class="text-sm text-red-600">{{ error() }}</span>
  </div>

  <ng-container *ngIf="grouped() as data">
    <div class="text-xs text-gray-500">Total records: {{ data.meta.total }} • Years: {{ data.meta.years.join(', ') }}</div>

    <div class="space-y-8">
      <div *ngFor="let year of data.meta.years" class="bg-white shadow rounded-lg border">
        <div class="px-5 py-3 border-b flex items-center justify-between">
          <h3 class="text-lg font-medium">{{ year }}</h3>
          <div class="text-sm text-gray-500">Metrics: {{ Object.keys(metricsByYearAndType()[year] || {}).length }}</div>
        </div>

        <div class="divide-y">
          <div *ngFor="let entry of (metricsByYearAndType()[year] | keyvalue)" class="p-5">
            <h4 class="font-semibold mb-3">
              {{ metricTypeName(entry.key as any) }}
            </h4>

            <table class="w-full text-sm border">
              <thead class="bg-gray-50">
                <tr>
                  <th class="text-left p-2 w-32">Quarter</th>
                  <th class="text-left p-2">Value</th>
                  <th class="text-left p-2 w-32">Margin %</th>
                  <th class="text-left p-2 w-44">Created</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngIf="annualValue(entry.value) as annual" class="bg-blue-50 font-medium">
                  <td class="p-2">Annual</td>
                  <td class="p-2">{{ annual | number }}</td>
                  <td class="p-2">{{ (entry.value.find(r=>r.quarter===null)?.margin_pct) ?? '-' }}</td>
                  <td class="p-2 text-xs">{{ entry.value.find(r=>r.quarter===null)?.created_at }}</td>
                </tr>
                <tr *ngFor="let q of quarterly(entry.value); let i = index" class="hover:bg-gray-50">
                  <td class="p-2">{{ q.quarter }}</td>
                  <td class="p-2">{{ q.value | number }}</td>
                  <td class="p-2">{{ q.margin_pct ?? '-' }}</td>
                  <td class="p-2 text-xs">{{ q.created_at }}</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </ng-container>

  <div *ngIf="!loading() && !error() && !grouped()" class="text-sm text-gray-500">
    No financial metrics found.
  </div>
</div>
