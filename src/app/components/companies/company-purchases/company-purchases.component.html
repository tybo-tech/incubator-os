<div class="container-fluid py-4">
  <!-- Quick Statistics Cards -->
  <div class="row mb-4">
    <div class="col-lg-3 col-md-6 mb-3">
      <div class="card bg-gradient-primary text-white shadow-sm border-0 h-100">
        <div class="card-body text-center py-4">
          <i class="fas fa-shopping-cart fa-2x mb-3 opacity-75"></i>
          <h4 class="card-title mb-1 fw-bold">{{ totalPurchases() }}</h4>
          <p class="card-text small mb-0 opacity-90">
            <i class="fas fa-box me-1"></i>Total Purchases
          </p>
        </div>
      </div>
    </div>
    <div class="col-lg-3 col-md-6 mb-3">
      <div class="card bg-gradient-success text-white shadow-sm border-0 h-100">
        <div class="card-body text-center py-4">
          <i class="fas fa-money-bill-wave fa-2x mb-3 opacity-75"></i>
          <h4 class="card-title mb-1 fw-bold">{{ formatCurrency(totalAmount()) }}</h4>
          <p class="card-text small mb-0 opacity-90">
            <i class="fas fa-wallet me-1"></i>Total Investment
          </p>
        </div>
      </div>
    </div>
    <div class="col-lg-3 col-md-6 mb-3">
      <div class="card bg-gradient-info text-white shadow-sm border-0 h-100">
        <div class="card-body text-center py-4">
          <i class="fas fa-calculator fa-2x mb-3 opacity-75"></i>
          <h4 class="card-title mb-1 fw-bold">{{ formatCurrency(averageAmount()) }}</h4>
          <p class="card-text small mb-0 opacity-90">
            <i class="fas fa-chart-line me-1"></i>Average Purchase
          </p>
        </div>
      </div>
    </div>
    <div class="col-lg-3 col-md-6 mb-3">
      <div class="card bg-gradient-warning text-white shadow-sm border-0 h-100">
        <div class="card-body text-center py-4">
          <i class="fas fa-tasks fa-2x mb-3 opacity-75"></i>
          <h4 class="card-title mb-1 fw-bold">{{ formatPercentage(completionRates().alignmentRate) }}</h4>
          <p class="card-text small mb-0 opacity-90">
            <i class="fas fa-check-circle me-1"></i>Completion Rate
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- Header and View Selector -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h3 class="mb-1 fw-bold text-dark">
        <i class="fas fa-list-alt me-2 text-primary"></i>Purchase Management
      </h3>
      <p class="text-muted mb-0 small">Track and manage company purchases funded by the incubator program</p>
    </div>
    <div class="btn-group shadow-sm" role="group">
      <button
        type="button"
        class="btn btn-outline-primary d-flex align-items-center"
        [class.active]="selectedView() === 'list'"
        (click)="setView('list')">
        <i class="fas fa-list me-2"></i>List View
      </button>
      <button
        type="button"
        class="btn btn-outline-primary d-flex align-items-center"
        [class.active]="selectedView() === 'statistics'"
        (click)="setView('statistics')">
        <i class="fas fa-chart-bar me-2"></i>Analytics
      </button>
      <button
        type="button"
        class="btn btn-outline-primary d-flex align-items-center"
        [class.active]="selectedView() === 'breakdown'"
        (click)="setView('breakdown')">
        <i class="fas fa-chart-pie me-2"></i>Breakdown
      </button>
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="loading()" class="text-center py-5">
    <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
      <span class="visually-hidden">Loading...</span>
    </div>
    <p class="mt-3 text-muted">Loading purchases data...</p>
  </div>

  <!-- Error State -->
  <div *ngIf="error()" class="alert alert-danger d-flex align-items-center" role="alert">
    <i class="fas fa-exclamation-triangle me-2"></i>
    <div class="flex-grow-1">{{ error() }}</div>
    <button class="btn btn-sm btn-outline-danger ms-3" (click)="loadData()">
      <i class="fas fa-redo me-1"></i>Retry
    </button>
  </div>

  <!-- List View -->
  <div *ngIf="selectedView() === 'list' && !loading()">
    <!-- Search and Filters Card -->
    <div class="card shadow-sm mb-4">
      <div class="card-header bg-light d-flex justify-content-between align-items-center">
        <h5 class="mb-0">
          <i class="fas fa-search me-2 text-primary"></i>Search & Filter
        </h5>
        <button class="btn btn-sm btn-outline-secondary" (click)="toggleFilters()">
          <i class="fas fa-filter me-1"></i>
          {{ showFilters() ? 'Hide Filters' : 'Show Filters' }}
        </button>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-8">
            <div class="input-group">
              <span class="input-group-text bg-light border-end-0">
                <i class="fas fa-search text-muted"></i>
              </span>
              <input
                type="text"
                class="form-control border-start-0"
                placeholder="Search by item description, type, or provider..."
                [(ngModel)]="searchTerm"
                (keyup.enter)="onSearch()">
              <button class="btn btn-primary" (click)="onSearch()">
                <i class="fas fa-search me-1"></i>Search
              </button>
            </div>
          </div>
          <div class="col-md-4 text-end">
            <button class="btn btn-outline-secondary me-2" (click)="clearFilters()">
              <i class="fas fa-times me-1"></i>Clear All
            </button>
            <button class="btn btn-success">
              <i class="fas fa-plus me-1"></i>Add Purchase
            </button>
          </div>
        </div>

        <!-- Advanced Filters -->
        <div *ngIf="showFilters()" class="row mt-4 pt-4 border-top">
          <div class="col-md-3 mb-3">
            <label class="form-label fw-semibold">
              <i class="fas fa-tag me-1 text-primary"></i>Purchase Type
            </label>
            <input type="text" class="form-control" placeholder="e.g., Equipment, Tools..."
                   [value]="filters().purchase_type || ''"
                   (input)="onPurchaseTypeChange($event)">
          </div>
          <div class="col-md-3 mb-3">
            <label class="form-label fw-semibold">
              <i class="fas fa-store me-1 text-primary"></i>Service Provider
            </label>
            <input type="text" class="form-control" placeholder="e.g., Company name..."
                   [value]="filters().service_provider || ''"
                   (input)="onServiceProviderChange($event)">
          </div>
          <div class="col-md-3 mb-3">
            <label class="form-label fw-semibold">
              <i class="fas fa-dollar-sign me-1 text-primary"></i>Min Amount
            </label>
            <input type="number" class="form-control" placeholder="0"
                   [value]="filters().min_amount || ''"
                   (input)="onMinAmountChange($event)">
          </div>
          <div class="col-md-3 mb-3">
            <label class="form-label fw-semibold">
              <i class="fas fa-dollar-sign me-1 text-primary"></i>Max Amount
            </label>
            <input type="number" class="form-control" placeholder="999999"
                   [value]="filters().max_amount || ''"
                   (input)="onMaxAmountChange($event)">
          </div>
        </div>
      </div>
    </div>

    <!-- Purchases List -->
    <div class="card shadow-sm" *ngIf="purchases().length > 0">
      <div class="card-header bg-light">
        <h5 class="mb-0">
          <i class="fas fa-receipt me-2 text-primary"></i>
          Purchase History <span class="badge bg-primary ms-2">{{ purchases().length }}</span>
        </h5>
      </div>
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-hover mb-0">
            <thead class="table-light">
              <tr>
                <th class="border-0 fw-semibold">
                  <i class="fas fa-box me-1"></i>Item & Details
                </th>
                <th class="border-0 fw-semibold">
                  <i class="fas fa-store me-1"></i>Provider
                </th>
                <th class="border-0 fw-semibold text-end">
                  <i class="fas fa-money-bill me-1"></i>Amount
                </th>
                <th class="border-0 fw-semibold text-center">
                  <i class="fas fa-clipboard-check me-1"></i>Status
                </th>
                <th class="border-0 fw-semibold">
                  <i class="fas fa-calendar me-1"></i>Date
                </th>
                <th class="border-0 fw-semibold text-center">Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let purchase of purchases(); trackBy: trackByPurchaseId" class="align-middle">
                <td>
                  <div class="d-flex align-items-start">
                    <div class="purchase-type-icon me-3">
                      <i class="fas fa-{{ getPurchaseTypeIcon(purchase.purchase_type) }} fa-lg text-primary"></i>
                    </div>
                    <div>
                      <h6 class="mb-1 fw-semibold">{{ purchase.purchase_type }}</h6>
                      <p class="mb-0 text-muted small">
                        <i class="fas fa-building me-1"></i>{{ purchase.service_provider }}
                        <span class="ms-2">
                          <i class="fas fa-calendar me-1"></i>{{ purchase.created_at | date:'MMM d, y' }}
                        </span>
                      </p>
                    </div>
                  </div>
                </td>
                <td>
                  <div class="d-flex align-items-center">
                    <i class="fas fa-building me-2 text-muted"></i>
                    <span class="fw-medium">{{ purchase.service_provider }}</span>
                  </div>
                </td>
                <td class="text-end">
                  <span class="fw-bold text-success fs-6">{{ formatCurrency(purchase.amount) }}</span>
                </td>
                <td class="text-center">
                  <div class="d-flex justify-content-center gap-2">
                    <span class="badge" [class]="getStatusBadgeClass('po', purchase.purchase_order)"
                          [title]="'Purchase Order: ' + (purchase.purchase_order ? 'Available' : 'Missing')">
                      <i class="fas fa-file-alt me-1"></i>PO
                    </span>
                    <span class="badge" [class]="getStatusBadgeClass('invoice', purchase.invoice_received)"
                          [title]="'Invoice: ' + (purchase.invoice_received ? 'Received' : 'Pending')">
                      <i class="fas fa-receipt me-1"></i>INV
                    </span>
                    <span class="badge" [class]="getStatusBadgeClass('delivery', purchase.items_received)"
                          [title]="'Items: ' + (purchase.items_received ? 'Delivered' : 'Pending')">
                      <i class="fas fa-truck me-1"></i>DEL
                    </span>
                  </div>
                </td>
                <td>
                  <div class="d-flex align-items-center">
                    <i class="fas fa-calendar-alt me-2 text-muted"></i>
                    <span class="small">{{ purchase.created_at | date:'MMM d, y' }}</span>
                  </div>
                </td>
                <td class="text-center">
                  <div class="btn-group btn-group-sm" role="group">
                    <button class="btn btn-outline-primary btn-sm" [title]="'Edit purchase'">
                      <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-outline-info btn-sm" [title]="'View details'">
                      <i class="fas fa-eye"></i>
                    </button>
                    <button class="btn btn-outline-danger btn-sm" [title]="'Delete purchase'">
                      <i class="fas fa-trash"></i>
                    </button>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- No Data State -->
    <div *ngIf="purchases().length === 0 && !loading()" class="card shadow-sm">
      <div class="card-body text-center py-5">
        <i class="fas fa-shopping-cart fa-3x text-muted mb-3"></i>
        <h5 class="text-muted">No Purchases Found</h5>
        <p class="text-muted mb-4">This company doesn't have any purchases recorded yet.</p>
        <button class="btn btn-primary">
          <i class="fas fa-plus me-2"></i>Add First Purchase
        </button>
      </div>
    </div>
  </div>

  <!-- Statistics View -->
  <div *ngIf="selectedView() === 'statistics' && !loading()">
    <div class="row" *ngIf="statistics()">
      <!-- Overview Card -->
      <div class="col-lg-6 mb-4">
        <div class="card shadow-sm h-100">
          <div class="card-header bg-primary text-white">
            <h5 class="mb-0">
              <i class="fas fa-chart-bar me-2"></i>Purchase Overview
            </h5>
          </div>
          <div class="card-body">
            <div class="row g-3">
              <div class="col-6">
                <div class="d-flex align-items-center p-3 bg-light rounded">
                  <i class="fas fa-shopping-cart fa-2x text-primary me-3"></i>
                  <div>
                    <h4 class="mb-0 fw-bold">{{ statistics()!.total_purchases }}</h4>
                    <small class="text-muted">Total Purchases</small>
                  </div>
                </div>
              </div>
              <div class="col-6">
                <div class="d-flex align-items-center p-3 bg-light rounded">
                  <i class="fas fa-money-bill-wave fa-2x text-success me-3"></i>
                  <div>
                    <h4 class="mb-0 fw-bold">{{ formatCurrency(statistics()!.total_amount) }}</h4>
                    <small class="text-muted">Total Amount</small>
                  </div>
                </div>
              </div>
              <div class="col-6">
                <div class="d-flex align-items-center p-3 bg-light rounded">
                  <i class="fas fa-calculator fa-2x text-info me-3"></i>
                  <div>
                    <h4 class="mb-0 fw-bold">{{ formatCurrency(statistics()!.average_amount) }}</h4>
                    <small class="text-muted">Average Amount</small>
                  </div>
                </div>
              </div>
              <div class="col-6">
                <div class="d-flex align-items-center p-3 bg-light rounded">
                  <i class="fas fa-arrow-up fa-2x text-warning me-3"></i>
                  <div>
                    <h4 class="mb-0 fw-bold">{{ formatCurrency(statistics()!.max_amount) }}</h4>
                    <small class="text-muted">Highest Purchase</small>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Completion Rates Card -->
      <div class="col-lg-6 mb-4">
        <div class="card shadow-sm h-100">
          <div class="card-header bg-success text-white">
            <h5 class="mb-0">
              <i class="fas fa-tasks me-2"></i>Completion Rates
            </h5>
          </div>
          <div class="card-body">
            <div class="mb-3">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <span><i class="fas fa-file-alt me-2 text-primary"></i>Purchase Orders</span>
                <span class="fw-bold">{{ formatPercentage(completionRates().purchaseOrderRate) }}</span>
              </div>
              <div class="progress" style="height: 8px;">
                <div class="progress-bar bg-primary"
                     [style.width.%]="completionRates().purchaseOrderRate"></div>
              </div>
            </div>
            <div class="mb-3">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <span><i class="fas fa-receipt me-2 text-success"></i>Invoices Received</span>
                <span class="fw-bold">{{ formatPercentage(completionRates().invoiceReceivedRate) }}</span>
              </div>
              <div class="progress" style="height: 8px;">
                <div class="progress-bar bg-success"
                     [style.width.%]="completionRates().invoiceReceivedRate"></div>
              </div>
            </div>
            <div class="mb-3">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <span><i class="fas fa-truck me-2 text-info"></i>Items Delivered</span>
                <span class="fw-bold">{{ formatPercentage(completionRates().itemsDeliveredRate) }}</span>
              </div>
              <div class="progress" style="height: 8px;">
                <div class="progress-bar bg-info"
                     [style.width.%]="completionRates().itemsDeliveredRate"></div>
              </div>
            </div>
            <div class="mb-0">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <span><i class="fas fa-check-circle me-2 text-warning"></i>Aligned with Program</span>
                <span class="fw-bold">{{ formatPercentage(completionRates().alignmentRate) }}</span>
              </div>
              <div class="progress" style="height: 8px;">
                <div class="progress-bar bg-warning"
                     [style.width.%]="completionRates().alignmentRate"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Breakdown View -->
  <div *ngIf="selectedView() === 'breakdown' && !loading()">
    <div class="row">
      <!-- Purchase Type Breakdown -->
      <div class="col-lg-6 mb-4">
        <div class="card shadow-sm">
          <div class="card-header bg-info text-white">
            <h5 class="mb-0">
              <i class="fas fa-chart-pie me-2"></i>Purchase Type Breakdown
            </h5>
          </div>
          <div class="card-body">
            <div *ngIf="typeBreakdown().length > 0">
              <div *ngFor="let type of typeBreakdown()" class="mb-3">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <div class="d-flex align-items-center">
                    <i class="fas fa-{{ getPurchaseTypeIcon(type.purchase_type) }} me-2 text-primary"></i>
                    <span class="fw-medium">{{ type.purchase_type }}</span>
                  </div>
                  <div class="text-end">
                    <div class="fw-bold">{{ formatCurrency(type.total_amount) }}</div>
                    <small class="text-muted">{{ type.count }} purchases</small>
                  </div>
                </div>
                <div class="progress" style="height: 8px;">
                  <div class="progress-bar bg-info"
                       [style.width.%]="(type.total_amount / totalAmount()) * 100"
                       [title]="formatPercentage((type.total_amount / totalAmount()) * 100)"></div>
                </div>
              </div>
            </div>
            <div *ngIf="typeBreakdown().length === 0" class="text-center text-muted py-4">
              <i class="fas fa-chart-pie fa-3x mb-3"></i>
              <p>No breakdown data available</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Service Provider Breakdown -->
      <div class="col-lg-6 mb-4">
        <div class="card shadow-sm">
          <div class="card-header bg-warning text-white">
            <h5 class="mb-0">
              <i class="fas fa-store me-2"></i>Service Provider Breakdown
            </h5>
          </div>
          <div class="card-body">
            <div *ngIf="providerBreakdown().length > 0">
              <div *ngFor="let provider of providerBreakdown()" class="mb-3">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <div class="d-flex align-items-center">
                    <i class="fas fa-building me-2 text-warning"></i>
                    <span class="fw-medium">{{ provider.service_provider }}</span>
                  </div>
                  <div class="text-end">
                    <div class="fw-bold">{{ formatCurrency(provider.total_amount) }}</div>
                    <small class="text-muted">{{ provider.count }} purchases</small>
                  </div>
                </div>
                <div class="progress" style="height: 8px;">
                  <div class="progress-bar bg-warning"
                       [style.width.%]="(provider.total_amount / totalAmount()) * 100"
                       [title]="formatPercentage((provider.total_amount / totalAmount()) * 100)"></div>
                </div>
              </div>
            </div>
            <div *ngIf="providerBreakdown().length === 0" class="text-center text-muted py-4">
              <i class="fas fa-store fa-3x mb-3"></i>
              <p>No breakdown data available</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
