<div class="bg-white rounded-lg shadow-sm p-6">
  <!-- Header -->
  <div class="flex items-center justify-between mb-6">
    <div class="flex items-center space-x-4">
      <div class="flex items-center">
        <i class="fas fa-coins text-yellow-600 text-2xl mr-3"></i>
        <h2 class="text-xl font-bold text-gray-900">Profit Summary</h2>
      </div>
      <!-- Save indicator -->
      <div *ngIf="saving" class="flex items-center text-yellow-600">
        <div
          class="animate-spin h-4 w-4 border-2 border-yellow-600 border-t-transparent rounded-full mr-2"
        ></div>
        <span class="text-sm font-medium">Saving...</span>
      </div>
    </div>

    <!-- Buttons container -->
    <div class="flex items-center space-x-3">
      <button
        (click)="openYearModal()"
        class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-yellow-600 hover:bg-yellow-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-yellow-500"
      >
        <i class="fas fa-plus mr-2"></i>
        Year
      </button>

      <!-- Save button (only show when there are pending changes) -->
      <button
        *ngIf="hasPendingChanges"
        (click)="saveAllChanges()"
        [disabled]="saving"
        class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 disabled:opacity-50 disabled:cursor-not-allowed"
      >
        <i *ngIf="!saving" class="fas fa-save mr-2"></i>
        <div
          *ngIf="saving"
          class="animate-spin h-4 w-4 border-2 border-white border-t-transparent rounded-full mr-2"
        ></div>
        {{ saving ? "Saving..." : "Save Changes" }}
        <span
          *ngIf="!saving"
          class="ml-2 bg-green-800 text-green-100 text-xs px-2 py-1 rounded-full"
        >
          {{ pendingChangesCount }}
        </span>
      </button>
    </div>
  </div>

  <!-- Loading -->
  <div *ngIf="loading" class="flex justify-center items-center py-10">
    <div
      class="animate-spin h-8 w-8 border-4 border-yellow-500 border-t-transparent rounded-full"
    ></div>
  </div>

  <!-- Tables -->
  <div *ngIf="!loading && profitSections.length > 0" class="space-y-10">
    <div *ngFor="let section of profitSections" class="overflow-x-auto">
      <div class="bg-gray-50 rounded-lg p-4 mb-4">
        <h3
          class="text-lg font-semibold text-gray-800 mb-3 flex items-center justify-between"
        >
          <div class="flex items-center">
            <i
              [ngClass]="{
                'fa-chart-line text-green-600': section.type === 'gross',
                'fa-cogs text-blue-600': section.type === 'operating',
                'fa-calculator text-purple-600': section.type === 'npbt'
              }"
              class="fas mr-3 text-xl"
            ></i>
            {{ section.displayName }}
            <span
              *ngIf="profitsHelper.hasRevenueData()"
              class="ml-2 text-xs bg-green-100 text-green-800 px-2 py-1 rounded-full"
              title="Margins calculated using actual revenue data for available years"
            >
              âœ“ Real Margins
            </span>
            <span
              *ngIf="!profitsHelper.hasRevenueData()"
              class="ml-2 text-xs bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full"
              title="Margins estimated (no revenue data available)"
            >
              ~ Estimated
            </span>
          </div>
          <span class="text-sm text-gray-500 font-normal">
            {{ section.rows.length }}
            {{ section.rows.length === 1 ? "year" : "years" }}
          </span>
        </h3>
      </div>

      <table
        class="min-w-full divide-y divide-gray-200 border border-gray-100 rounded-lg overflow-hidden table-fixed"
      >
        <thead class="bg-gray-50">
          <tr>
            <th
              class="w-32 px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
            >
              Year
            </th>
            <th
              class="w-28 px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider"
            >
              Q1
            </th>
            <th
              class="w-28 px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider"
            >
              Q2
            </th>
            <th
              class="w-28 px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider"
            >
              Q3
            </th>
            <th
              class="w-28 px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider"
            >
              Q4
            </th>
            <th
              class="w-32 px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider"
            >
              Total
            </th>
            <th
              class="w-24 px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider"
            >
              Margin
            </th>
            <th
              class="w-16 px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider"
            >
              Actions
            </th>
          </tr>
        </thead>

        <tbody class="bg-white divide-y divide-gray-200">
          <!-- Empty state for individual sections -->
          <tr *ngIf="section.rows.length === 0">
            <td colspan="8" class="px-4 py-8 text-center text-gray-400 italic">
              <i class="fas fa-chart-bar text-2xl mb-2 block text-gray-300"></i>
              No {{ section.displayName.toLowerCase() }} data available.
            </td>
          </tr>

          <!-- Data rows with inline editing -->
          <tr
            *ngFor="let row of section.rows; trackBy: profitsHelper.trackById"
            class="hover:bg-gray-50 transition-colors"
          >
            <!-- Editable Year -->
            <td class="px-4 py-4 text-sm font-medium text-gray-900">
              <input
                type="number"
                [(ngModel)]="row.year"
                (change)="onFieldChange(row, 'year', section)"
                [ngClass]="{
                  'border-green-400 bg-green-50 transition-all duration-500':
                    row.justSaved,
                  'border-orange-300 bg-orange-50': row.isPendingSave,
                  'border-yellow-300 bg-yellow-50': saving,
                  'border-gray-300':
                    !row.justSaved && !row.isPendingSave && !saving
                }"
                class="w-20 px-2 py-1 text-sm rounded focus:ring-2 focus:ring-yellow-500 focus:border-transparent text-center"
                [disabled]="saving"
                min="2000"
                max="2099"
                step="1"
              />
            </td>

            <!-- Editable Q1 -->
            <td class="px-4 py-4 text-sm text-center">
              <input
                type="number"
                [(ngModel)]="row.q1"
                (change)="onFieldChange(row, 'q1', section)"
                [ngClass]="{
                  'border-green-400 bg-green-50 transition-all duration-500':
                    row.justSaved,
                  'border-orange-300 bg-orange-50': row.isPendingSave,
                  'border-yellow-300 bg-yellow-50': saving,
                  'border-gray-300':
                    !row.justSaved && !row.isPendingSave && !saving
                }"
                class="w-24 px-2 py-1 text-sm rounded focus:ring-2 focus:ring-yellow-500 focus:border-transparent text-center"
                [disabled]="saving"
                placeholder="0"
                step="1"
              />
            </td>

            <!-- Editable Q2 -->
            <td class="px-4 py-4 text-sm text-center">
              <input
                type="number"
                [(ngModel)]="row.q2"
                (change)="onFieldChange(row, 'q2', section)"
                [ngClass]="{
                  'border-green-400 bg-green-50 transition-all duration-500':
                    row.justSaved,
                  'border-yellow-300 bg-yellow-50': saving,
                  'border-gray-300': !row.justSaved && !saving
                }"
                class="w-24 px-2 py-1 text-sm rounded focus:ring-2 focus:ring-yellow-500 focus:border-transparent text-center"
                [disabled]="saving"
                placeholder="0"
                step="1"
              />
            </td>

            <!-- Editable Q3 -->
            <td class="px-4 py-4 text-sm text-center">
              <input
                type="number"
                [(ngModel)]="row.q3"
                (change)="onFieldChange(row, 'q3', section)"
                [ngClass]="{
                  'border-green-400 bg-green-50 transition-all duration-500':
                    row.justSaved,
                  'border-yellow-300 bg-yellow-50': saving,
                  'border-gray-300': !row.justSaved && !saving
                }"
                class="w-24 px-2 py-1 text-sm rounded focus:ring-2 focus:ring-yellow-500 focus:border-transparent text-center"
                [disabled]="saving"
                placeholder="0"
                step="1"
              />
            </td>

            <!-- Editable Q4 -->
            <td class="px-4 py-4 text-sm text-center">
              <input
                type="number"
                [(ngModel)]="row.q4"
                (change)="onFieldChange(row, 'q4', section)"
                [ngClass]="{
                  'border-green-400 bg-green-50 transition-all duration-500':
                    row.justSaved,
                  'border-yellow-300 bg-yellow-50': saving,
                  'border-gray-300': !row.justSaved && !saving
                }"
                class="w-24 px-2 py-1 text-sm rounded focus:ring-2 focus:ring-yellow-500 focus:border-transparent text-center"
                [disabled]="saving"
                placeholder="0"
                step="1"
              />
            </td>

            <!-- Calculated Total (readonly) -->
            <td
              class="px-4 py-4 text-sm text-center font-semibold text-gray-900"
            >
              {{ profitsHelper.formatCurrencyWithUnit(row.total) }}
            </td>

            <!-- Calculated Margin (readonly with colors) - only show if revenue available for this year -->
            <td
              class="px-4 py-4 text-sm text-center font-semibold"
              [ngClass]="{
                'text-green-600':
                  profitsHelper.hasRevenueForYear(row.year) &&
                  row.margin_pct !== null &&
                  row.margin_pct >= 50,
                'text-yellow-600':
                  profitsHelper.hasRevenueForYear(row.year) &&
                  row.margin_pct !== null &&
                  row.margin_pct >= 30 &&
                  row.margin_pct < 50,
                'text-red-500':
                  profitsHelper.hasRevenueForYear(row.year) &&
                  row.margin_pct !== null &&
                  row.margin_pct < 30 &&
                  row.margin_pct >= 0,
                'text-red-600':
                  profitsHelper.hasRevenueForYear(row.year) &&
                  row.margin_pct !== null &&
                  row.margin_pct < 0,
                'text-gray-400': !profitsHelper.hasRevenueForYear(row.year)
              }"
            >
              <span *ngIf="profitsHelper.hasRevenueForYear(row.year)">
                {{ profitsHelper.formatPercentage(row.margin_pct) }}
              </span>
              <span
                *ngIf="!profitsHelper.hasRevenueForYear(row.year)"
                class="text-gray-400"
              >
                -
              </span>
            </td>

            <!-- Actions -->
            <td class="px-4 py-4 text-sm text-center">
              <button
                (click)="deleteYearRecord(row.id, row.year)"
                class="text-gray-400 hover:text-red-500 transition-colors"
                title="Delete {{ row.year }} data"
              >
                <i class="fas fa-trash text-sm"></i>
              </button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Empty -->
  <div *ngIf="!loading && allSectionsEmpty" class="text-center py-12">
    <i class="fas fa-chart-pie text-gray-400 text-4xl mb-3"></i>
    <h3 class="text-lg font-medium text-gray-900">No Profit Data</h3>
    <p class="text-gray-600 mb-4">
      Start by adding your first year's profit data.
    </p>
    <button
      (click)="openYearModal()"
      class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-yellow-600 hover:bg-yellow-700"
    >
      <i class="fas fa-plus mr-2"></i>
      Add Year
    </button>
  </div>

  <!-- Year Modal -->
  <app-year-modal
    #yearModal
    [existingYears]="existingYears"
    (yearSelected)="onYearSelected($event)"
    (modalClosed)="onModalClosed()"
  >
  </app-year-modal>
</div>
