<div class="bg-white shadow-sm rounded-lg border border-gray-200 overflow-hidden">
  <!-- Table Header -->
  <div class="px-6 py-4 border-b border-gray-200 bg-gray-50">
    <h3 class="text-lg font-medium text-gray-900">Data Records</h3>
  </div>

  <!-- Table Content -->
  <div class="overflow-x-auto">
    <!-- Dynamic Schema-based Table -->
    <table class="min-w-full divide-y divide-gray-200" *ngIf="tableConfig && displayData.length > 0; else fallbackOrEmpty">
      <thead class="bg-gray-50">
        <tr>
          <th *ngFor="let column of tableConfig.columns; trackBy: trackByColumnKey"
              scope="col"
              [class]="getHeaderClasses(column)"
              [style.width]="column.width">
            <div class="flex items-center space-x-2">
              <lucide-icon [img]="getIconForType(column.type)" class="h-4 w-4 text-gray-500"></lucide-icon>
              <span>{{ column.label }}</span>
              <span *ngIf="column.required" class="text-red-500 ml-1">*</span>
            </div>
          </th>
          <th scope="col" class="relative px-6 py-3">
            <span class="sr-only">Actions</span>
          </th>
        </tr>
      </thead>
      <tbody class="bg-white divide-y divide-gray-200">
        <tr *ngFor="let node of displayData; trackBy: trackByNodeId"
            class="hover:bg-gray-50 cursor-pointer"
            [class.bg-blue-50]="selectedNode?.id === node.id"
            (click)="onSelectRow(node)">

          <!-- Dynamic Schema Columns -->
          <td *ngFor="let column of tableConfig.columns; trackBy: trackByColumnKey"
              [class]="getColumnClasses(column)"
              [attr.title]="getDisplayValue(column.type === 'id' ? node : node.data, column)">

            <!-- Special handling for system columns -->
            <ng-container [ngSwitch]="column.type">
              <!-- ID Column -->
              <span *ngSwitchCase="'id'">{{ node.id }}</span>

              <!-- Type Column -->
              <span *ngSwitchCase="'type'"
                    class="inline-flex px-2 py-1 text-xs font-medium rounded-full"
                    [class]="getTypeColor(node.type)">
                {{ node.type }}
              </span>

              <!-- Created Column -->
              <span *ngSwitchCase="'created'">{{ node.created_at | date:'short' }}</span>

              <!-- Checkbox Column -->
              <span *ngSwitchCase="'checkbox'" class="flex justify-center">
                <span class="inline-flex items-center">
                  <lucide-icon *ngIf="getDisplayValue(node.data, column) === 'Yes'"
                       [img]="CheckIcon" class="h-4 w-4 text-green-500"></lucide-icon>
                  <lucide-icon *ngIf="getDisplayValue(node.data, column) !== 'Yes'"
                       [img]="XIcon" class="h-4 w-4 text-gray-300"></lucide-icon>
                </span>
              </span>

              <!-- JSON Column with expandable preview -->
              <span *ngSwitchCase="'json'"
                    class="font-mono text-xs bg-gray-100 px-2 py-1 rounded max-w-xs truncate block">
                {{ getDisplayValue(node.data, column) }}
              </span>

              <!-- Default data columns -->
              <span *ngSwitchDefault
                    [class.max-w-xs]="column.type === 'textarea'"
                    [class.truncate]="column.type === 'textarea'">
                {{ getDisplayValue(node.data, column) }}
              </span>
            </ng-container>
          </td>

          <!-- Actions Column -->
          <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
            <div class="flex items-center space-x-2">
              <button
                (click)="onEditRow(node); $event.stopPropagation()"
                class="text-blue-600 hover:text-blue-900 p-1 rounded"
                title="Edit record">
                <lucide-icon [img]="EditIcon" class="h-4 w-4"></lucide-icon>
              </button>
              <button
                (click)="onDeleteRow(node); $event.stopPropagation()"
                class="text-red-600 hover:text-red-900 p-1 rounded"
                title="Delete record">
                <lucide-icon [img]="TrashIcon" class="h-4 w-4"></lucide-icon>
              </button>
            </div>
          </td>
        </tr>
      </tbody>
    </table>

    <!-- Fallback table for when no schema is available or empty state -->
    <ng-template #fallbackOrEmpty>
      <!-- Legacy table when no table config is available -->
      <table class="min-w-full divide-y divide-gray-200" *ngIf="displayData.length > 0 && !tableConfig">
        <thead class="bg-gray-50">
          <tr>
            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
              ID
            </th>
            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
              Type
            </th>
            <th *ngFor="let key of getDataKeys(displayData)"
                scope="col"
                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
              {{ key }}
            </th>
            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
              Created
            </th>
            <th scope="col" class="relative px-6 py-3">
              <span class="sr-only">Actions</span>
            </th>
          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200">
          <tr *ngFor="let node of displayData; trackBy: trackByNodeId"
              class="hover:bg-gray-50 cursor-pointer"
              [class.bg-blue-50]="selectedNode?.id === node.id"
              (click)="onSelectRow(node)">
            <!-- ID Column -->
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
              {{ node.id }}
            </td>

            <!-- Type Column -->
            <td class="px-6 py-4 whitespace-nowrap">
              <span class="inline-flex px-2 py-1 text-xs font-medium rounded-full"
                    [class]="getTypeColor(node.type)">
                {{ node.type }}
              </span>
            </td>

            <!-- Dynamic Data Columns -->
            <td *ngFor="let key of getDataKeys(displayData)"
                class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 max-w-xs truncate">
              {{ getLegacyDisplayValue(node.data, key) }}
            </td>

            <!-- Created Date Column -->
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
              {{ node.created_at | date:'short' }}
            </td>

            <!-- Actions Column -->
            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
              <div class="flex items-center space-x-2">
                <button
                  (click)="onEditRow(node); $event.stopPropagation()"
                  class="text-blue-600 hover:text-blue-900 p-1 rounded">
                  <lucide-icon [img]="EditIcon" class="h-4 w-4"></lucide-icon>
                </button>
                <button
                  (click)="onDeleteRow(node); $event.stopPropagation()"
                  class="text-red-600 hover:text-red-900 p-1 rounded">
                  <lucide-icon [img]="TrashIcon" class="h-4 w-4"></lucide-icon>
                </button>
              </div>
            </td>
          </tr>
        </tbody>
      </table>

      <!-- Empty State -->
      <div class="text-center py-12" *ngIf="displayData.length === 0">
        <lucide-icon [img]="FileTextIcon" class="mx-auto h-12 w-12 text-gray-400"></lucide-icon>
        <h3 class="mt-2 text-sm font-medium text-gray-900">No records found</h3>
        <p class="mt-1 text-sm text-gray-500">
          {{ collection?.data?.name ? 'No data found for this collection.' : 'No collection data available.' }}
        </p>
        <p class="mt-1 text-xs text-gray-400" *ngIf="tableConfig">
          Schema loaded with {{ tableConfig.columns.length }} columns defined
        </p>
      </div>
    </ng-template>
  </div>
</div>
