<div
      class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50"
      *ngIf="isVisible"
      (click)="onBackdropClick($event)"
    >
      <div
        class="relative top-20 mx-auto p-5 border w-11/12 max-w-4xl shadow-lg rounded-md bg-white"
        (click)="$event.stopPropagation()"
      >
        <!-- Modal Header -->
        <div
          class="flex items-center justify-between pb-4 mb-4 border-b border-gray-200"
        >
          <h3 class="text-lg font-medium text-gray-900">
            {{ isEditMode ? 'Edit' : 'Add New' }}
            {{ collection?.data?.name || 'Record' }}
          </h3>
          <button
            (click)="onClose()"
            class="text-gray-400 hover:text-gray-600 transition-colors"
          >
            <svg
              class="h-6 w-6"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"
              />
            </svg>
          </button>
        </div>

        <!-- Form Content -->
        <form
          [formGroup]="mainForm"
          (ngSubmit)="onSubmit()"
          *ngIf="formGroups.length > 0"
        >
          <!-- Group-based Form Sections -->
          <div class="space-y-8">
            <div
              *ngFor="let groupConfig of formGroups"
              class="bg-gray-50 rounded-lg p-6"
            >
              <!-- Group Header -->
              <div class="mb-4">
                <h4 class="text-md font-semibold text-gray-800">
                  {{ groupConfig.group.name }}
                </h4>
                <p
                  *ngIf="groupConfig.group.description"
                  class="text-sm text-gray-600 mt-1"
                >
                  {{ groupConfig.group.description }}
                </p>
              </div>

              <!-- Group Fields -->
              <div
                class="grid grid-cols-1 md:grid-cols-2 gap-4"
                [formGroup]="groupConfig.formGroup"
              >
                <div
                  *ngFor="let field of groupConfig.fields"
                  [class.md:col-span-2]="field.type === 'textarea'"
                  class="space-y-1"
                >
                  <!-- Field Label -->
                  <label
                    [for]="field.key"
                    class="block text-sm font-medium text-gray-700"
                  >
                    {{ field.label }}
                    <span *ngIf="field.required" class="text-red-500 ml-1"
                      >*</span
                    >
                  </label>

                  <!-- Field Input based on type -->
                  <ng-container [ngSwitch]="field.type">
                    <!-- Text Input -->
                    <input
                      *ngSwitchCase="'text'"
                      [id]="field.key"
                      [formControlName]="field.key"
                      type="text"
                      [placeholder]="field.placeholder || ''"
                      class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
                      [class.border-red-300]="
                        isFieldInvalid(groupConfig.formGroup, field.key)
                      "
                    />

                    <!-- Textarea -->
                    <textarea
                      *ngSwitchCase="'textarea'"
                      [id]="field.key"
                      [formControlName]="field.key"
                      rows="3"
                      [placeholder]="field.placeholder || ''"
                      class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
                      [class.border-red-300]="
                        isFieldInvalid(groupConfig.formGroup, field.key)
                      "
                    >
                    </textarea>

                    <!-- Number Input -->
                    <input
                      *ngSwitchCase="'number'"
                      [id]="field.key"
                      [formControlName]="field.key"
                      type="number"
                      [placeholder]="field.placeholder || ''"
                      class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
                      [class.border-red-300]="
                        isFieldInvalid(groupConfig.formGroup, field.key)
                      "
                    />

                    <!-- Date Input -->
                    <input
                      *ngSwitchCase="'date'"
                      [id]="field.key"
                      [formControlName]="field.key"
                      type="date"
                      class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
                      [class.border-red-300]="
                        isFieldInvalid(groupConfig.formGroup, field.key)
                      "
                    />

                    <!-- Select Dropdown -->
                    <div *ngSwitchCase="'select'">
                      <!-- Single Select -->
                      <select
                        *ngIf="!field.multiple"
                        [id]="field.key"
                        [formControlName]="field.key"
                        class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
                        [class.border-red-300]="
                          isFieldInvalid(groupConfig.formGroup, field.key)
                        "
                      >
                        <option value="">Select {{ field.label }}</option>
                        <option
                          *ngFor="
                            let option of getFieldOptions(field);
                            trackBy: trackByOption
                          "
                          [value]="option.value"
                        >
                          {{ option.label }}
                        </option>
                      </select>

                      <!-- Multi Select -->
                      <app-multi-select
                        *ngIf="field.multiple"
                        [sourceCollectionId]="field.sourceCollectionId"
                        [labelField]="field.labelField || 'name'"
                        [placeholder]="'Select ' + field.label"
                        [formControlName]="field.key"
                      >
                      </app-multi-select>
                    </div>

                    <!-- Checkbox -->
                    <div *ngSwitchCase="'checkbox'" class="flex items-center">
                      <input
                        [id]="field.key"
                        [formControlName]="field.key"
                        type="checkbox"
                        class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
                      />
                      <label
                        [for]="field.key"
                        class="ml-2 block text-sm text-gray-900"
                      >
                        {{ field.placeholder || 'Yes' }}
                      </label>
                    </div>

                    <!-- JSON Input (textarea with validation) -->
                    <textarea
                      *ngSwitchCase="'json'"
                      [id]="field.key"
                      [formControlName]="field.key"
                      rows="4"
                      [placeholder]="field.placeholder || 'Enter valid JSON'"
                      class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm font-mono text-xs"
                      [class.border-red-300]="
                        isFieldInvalid(groupConfig.formGroup, field.key)
                      "
                    >
                    </textarea>
                  </ng-container>

                  <!-- Field Error Message -->
                  <div
                    *ngIf="isFieldInvalid(groupConfig.formGroup, field.key)"
                    class="text-red-600 text-xs mt-1"
                  >
                    <span
                      *ngIf="groupConfig.formGroup.get(field.key)?.errors?.['required']"
                    >
                      {{ field.label }} is required
                    </span>
                    <span
                      *ngIf="groupConfig.formGroup.get(field.key)?.errors?.['invalidJson']"
                    >
                      Invalid JSON format
                    </span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Modal Footer -->
          <div
            class="flex items-center justify-end pt-6 mt-6 border-t border-gray-200 space-x-3"
          >
            <button
              type="button"
              (click)="onClose()"
              class="px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
            >
              Cancel
            </button>
            <button
              type="submit"
              [disabled]="mainForm.invalid || isSubmitting"
              class="px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed"
            >
              <span *ngIf="!isSubmitting"
                >{{ isEditMode ? 'Update' : 'Create' }} Record</span
              >
              <span *ngIf="isSubmitting">Saving...</span>
            </button>
          </div>
        </form>

        <!-- No Schema Available -->
        <div *ngIf="formGroups.length === 0" class="text-center py-8">
          <div class="text-gray-400 mb-4">
            <svg
              class="mx-auto h-12 w-12"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
              />
            </svg>
          </div>
          <h3 class="text-lg font-medium text-gray-900 mb-2">
            No Form Schema Available
          </h3>
          <p class="text-sm text-gray-600">
            Cannot create a form without a collection schema. Please ensure the
            collection has defined fields.
          </p>
          <button
            (click)="onClose()"
            class="mt-4 px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700"
          >
            Close
          </button>
        </div>
      </div>
    </div>